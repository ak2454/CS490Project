{"ast":null,"code":"'use strict'; // https://mysqlserverteam.com/mysql-8-0-4-new-default-authentication-plugin-caching_sha2_password/\n\nvar PLUGIN_NAME = 'caching_sha2_password';\n\nvar crypto = require('crypto');\n\nvar _require = require('../auth_41'),\n    xor = _require.xor,\n    xorRotating = _require.xorRotating;\n\nvar REQUEST_SERVER_KEY_PACKET = Buffer.from([2]);\nvar FAST_AUTH_SUCCESS_PACKET = Buffer.from([3]);\nvar PERFORM_FULL_AUTHENTICATION_PACKET = Buffer.from([4]);\nvar STATE_INITIAL = 0;\nvar STATE_TOKEN_SENT = 1;\nvar STATE_WAIT_SERVER_KEY = 2;\nvar STATE_FINAL = -1;\n\nfunction sha256(msg) {\n  var hash = crypto.createHash('sha256');\n  hash.update(msg, 'binary');\n  return hash.digest('binary');\n}\n\nfunction calculateToken(password, scramble) {\n  if (!password) {\n    return Buffer.alloc(0);\n  }\n\n  var stage1 = sha256(Buffer.from(password, 'utf8').toString('binary'));\n  var stage2 = sha256(stage1);\n  var stage3 = sha256(stage2 + scramble.toString('binary'));\n  return xor(stage1, stage3);\n}\n\nfunction encrypt(password, scramble, key) {\n  var stage1 = xorRotating(Buffer.from(\"\".concat(password, \"\\0\"), 'utf8').toString('binary'), scramble.toString('binary'));\n  return crypto.publicEncrypt(key, stage1);\n}\n\nmodule.exports = function () {\n  var pluginOptions = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n  return function (_ref) {\n    var connection = _ref.connection;\n    var state = 0;\n    var scramble = null;\n    var password = connection.config.password;\n\n    var authWithKey = function authWithKey(serverKey) {\n      var _password = encrypt(password, scramble, serverKey);\n\n      state = STATE_FINAL;\n      return _password;\n    };\n\n    return function (data) {\n      switch (state) {\n        case STATE_INITIAL:\n          scramble = data.slice(0, 20);\n          state = STATE_TOKEN_SENT;\n          return calculateToken(password, scramble);\n\n        case STATE_TOKEN_SENT:\n          if (FAST_AUTH_SUCCESS_PACKET.equals(data)) {\n            state = STATE_FINAL;\n            return null;\n          }\n\n          if (PERFORM_FULL_AUTHENTICATION_PACKET.equals(data)) {\n            var isSecureConnection = typeof pluginOptions.overrideIsSecure === 'undefined' ? connection.config.ssl || connection.config.socketPath : pluginOptions.overrideIsSecure;\n\n            if (isSecureConnection) {\n              state = STATE_FINAL;\n              return Buffer.from(\"\".concat(password, \"\\0\"), 'utf8');\n            } // if client provides key we can save one extra roundrip on first connection\n\n\n            if (pluginOptions.serverPublicKey) {\n              return authWithKey(pluginOptions.serverPublicKey);\n            }\n\n            state = STATE_WAIT_SERVER_KEY;\n            return REQUEST_SERVER_KEY_PACKET;\n          }\n\n          throw new Error(\"Invalid AuthMoreData packet received by \".concat(PLUGIN_NAME, \" plugin in STATE_TOKEN_SENT state.\"));\n\n        case STATE_WAIT_SERVER_KEY:\n          if (pluginOptions.onServerPublicKey) {\n            pluginOptions.onServerPublicKey(data);\n          }\n\n          return authWithKey(data);\n\n        case STATE_FINAL:\n          throw new Error(\"Unexpected data in AuthMoreData packet received by \".concat(PLUGIN_NAME, \" plugin in STATE_FINAL state.\"));\n      }\n\n      throw new Error(\"Unexpected data in AuthMoreData packet received by \".concat(PLUGIN_NAME, \" plugin in state \").concat(state));\n    };\n  };\n};","map":{"version":3,"sources":["/root/Test/node_modules/mysql2/lib/auth_plugins/caching_sha2_password.js"],"names":["PLUGIN_NAME","crypto","require","xor","xorRotating","REQUEST_SERVER_KEY_PACKET","Buffer","from","FAST_AUTH_SUCCESS_PACKET","PERFORM_FULL_AUTHENTICATION_PACKET","STATE_INITIAL","STATE_TOKEN_SENT","STATE_WAIT_SERVER_KEY","STATE_FINAL","sha256","msg","hash","createHash","update","digest","calculateToken","password","scramble","alloc","stage1","toString","stage2","stage3","encrypt","key","publicEncrypt","module","exports","pluginOptions","connection","state","config","authWithKey","serverKey","_password","data","slice","equals","isSecureConnection","overrideIsSecure","ssl","socketPath","serverPublicKey","Error","onServerPublicKey"],"mappings":"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","sourcesContent":["'use strict';\n\n// https://mysqlserverteam.com/mysql-8-0-4-new-default-authentication-plugin-caching_sha2_password/\n\nconst PLUGIN_NAME = 'caching_sha2_password';\nconst crypto = require('crypto');\nconst { xor, xorRotating } = require('../auth_41');\n\nconst REQUEST_SERVER_KEY_PACKET = Buffer.from([2]);\nconst FAST_AUTH_SUCCESS_PACKET = Buffer.from([3]);\nconst PERFORM_FULL_AUTHENTICATION_PACKET = Buffer.from([4]);\n\nconst STATE_INITIAL = 0;\nconst STATE_TOKEN_SENT = 1;\nconst STATE_WAIT_SERVER_KEY = 2;\nconst STATE_FINAL = -1;\n\nfunction sha256(msg) {\n  const hash = crypto.createHash('sha256');\n  hash.update(msg, 'binary');\n  return hash.digest('binary');\n}\n\nfunction calculateToken(password, scramble) {\n  if (!password) {\n    return Buffer.alloc(0);\n  }\n  const stage1 = sha256(Buffer.from(password, 'utf8').toString('binary'));\n  const stage2 = sha256(stage1);\n  const stage3 = sha256(stage2 + scramble.toString('binary'));\n  return xor(stage1, stage3);\n}\n\nfunction encrypt(password, scramble, key) {\n  const stage1 = xorRotating(\n    Buffer.from(`${password}\\0`, 'utf8').toString('binary'),\n    scramble.toString('binary')\n  );\n  return crypto.publicEncrypt(key, stage1);\n}\n\nmodule.exports = (pluginOptions = {}) => ({ connection }) => {\n  let state = 0;\n  let scramble = null;\n\n  const password = connection.config.password;\n\n  const authWithKey = serverKey => {\n    const _password = encrypt(password, scramble, serverKey);\n    state = STATE_FINAL;\n    return _password;\n  };\n\n  return data => {\n    switch (state) {\n      case STATE_INITIAL:\n        scramble = data.slice(0, 20);\n        state = STATE_TOKEN_SENT;\n        return calculateToken(password, scramble);\n\n      case STATE_TOKEN_SENT:\n        if (FAST_AUTH_SUCCESS_PACKET.equals(data)) {\n          state = STATE_FINAL;\n          return null;\n        }\n\n        if (PERFORM_FULL_AUTHENTICATION_PACKET.equals(data)) {\n          const isSecureConnection =\n            typeof pluginOptions.overrideIsSecure === 'undefined'\n              ? connection.config.ssl || connection.config.socketPath\n              : pluginOptions.overrideIsSecure;\n          if (isSecureConnection) {\n            state = STATE_FINAL;\n            return Buffer.from(`${password}\\0`, 'utf8');\n          }\n\n          // if client provides key we can save one extra roundrip on first connection\n          if (pluginOptions.serverPublicKey) {\n            return authWithKey(pluginOptions.serverPublicKey);\n          }\n\n          state = STATE_WAIT_SERVER_KEY;\n          return REQUEST_SERVER_KEY_PACKET;\n        }\n        throw new Error(\n          `Invalid AuthMoreData packet received by ${PLUGIN_NAME} plugin in STATE_TOKEN_SENT state.`\n        );\n      case STATE_WAIT_SERVER_KEY:\n        if (pluginOptions.onServerPublicKey) {\n          pluginOptions.onServerPublicKey(data);\n        }\n        return authWithKey(data);\n      case STATE_FINAL:\n        throw new Error(\n          `Unexpected data in AuthMoreData packet received by ${PLUGIN_NAME} plugin in STATE_FINAL state.`\n        );\n    }\n\n    throw new Error(\n      `Unexpected data in AuthMoreData packet received by ${PLUGIN_NAME} plugin in state ${state}`\n    );\n  };\n};\n"]},"metadata":{},"sourceType":"script"}